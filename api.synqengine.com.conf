include sites-available/api.synqengine.com/before/*; # Managed by SpinupWP

server {
        listen 443 ssl; # Managed by SpinupWP
        listen [::]:443 ssl; # Managed by SpinupWP
        http2 on; # Managed by SpinupWP

        server_name api.synqengine.com; # Managed by SpinupWP

        ssl_certificate /etc/letsencrypt/live/api.synqengine.com/fullchain.pem; # Managed by SpinupWP
        ssl_certificate_key /etc/letsencrypt/live/api.synqengine.com/privkey.pem; # Managed by SpinupWP

        root /sites/api.synqengine.com/files/;

        index index.html index.php;

        access_log /sites/api.synqengine.com/logs/access.log;
        error_log /sites/api.synqengine.com/logs/error.log;

        # Don't allow pages to be rendered in an iframe on external domains.
        add_header X-Frame-Options "SAMEORIGIN";

        # MIME sniffing prevention
        add_header X-Content-Type-Options "nosniff";

        # Enable cross-site scripting filter in supported browsers.
        add_header X-Xss-Protection "1; mode=block";

        # Limit referrer information sent with requests to third parties.
        add_header Referrer-Policy "strict-origin-when-cross-origin";

        include sites-available/api.synqengine.com/server/*; # Managed by SpinupWP

        # Prevent access to hidden files
        location ~* /\.(?!well-known\/) {
                deny all;
        }

# Prevent access to certain file extensions
        location ~ \.(ini|log|conf|blade.php)$ {
                deny all;
        }

        # API host: proxy Node backend (Fastify) running on localhost:3001
        # Return 404 for the site root so we don't accidentally serve files from disk.
        location = / {
                return 404;
        }

        # Proxy all API requests to the Node service
        location ^~ /api/ {
                proxy_pass http://127.0.0.1:3001;

                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                proxy_read_timeout 120s;
                proxy_send_timeout 120s;
        }

        location ~ \.php$ {
                try_files $uri =404;

                include fastcgi.conf;
                fastcgi_pass unix:/run/php/php8.3-synqengine.sock;

                include sites-available/api.synqengine.com/location/*; # Managed by SpinupWP
        }
}

include sites-available/api.synqengine.com/after/*; # Managed by SpinupWP